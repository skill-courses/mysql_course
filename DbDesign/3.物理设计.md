# 物理设计

本机主要的目的是学习物理设计的基本概念，掌握物理设计的几种方法。



## 概述

**定义：数据库的物理设计就是设计数据库的物理结果的过程，需要根据数据库的逻辑模型来选定DBMS，并设计和实施数据库的存储结构、存取方式等。**

从上面的定义可以看出，数据库的物理设计依赖于实体数据库，所以数据库的物理设计工作包括以下几点：

* **根据数据库模型来选择合适的DBMS。**
* **根据所选择的DBMS和数据模型特点来选择合适的数据库引擎。**
* **根据所选择的数据库引擎来定义库、表、字段等。**

接下来，我们一一讲解数据库物理设计的内容：



## 选择DBMS

常用的关系型DBMS有Oracle，SQLServer，MySQL，PgSQL等，要从这些DBMS里面选择合适的数据库DBMS，通常考虑两个方面：**应用特点和成本。**

我们在数据库概述一节中，介绍过下面一个表：

| 项目的规模 | 负载（负载量有多大，即用户数有多大）                         | 成本           | 安全性                     |
| :--------- | :----------------------------------------------------------- | -------------- | -------------------------- |
| 小型数据库 | 负载量小，用户大概100人之内 比如：留言板、信息管理系统       | 成本在千元之内 | 对安全性要求不高           |
| 中型数据库 | 日访问量5000~10000                                           | 成本在万元内   | 比如商务网站（安全性较高） |
| 大型数据库 | 海量负载，可以处理海量数据(sybase<oracle<db2(海量数据处理能力)) | 相对贵         | 安全性高                   |

通常来说，SQLServer和MySQL是属于中型数据库，应用于日均访问在10000左右的应用。Oracle和PgSQL是大型数据库，可以处理海量数据，而且可扩展能力比较强。另外，如果应用程序是用.NET来写的，并且部署在Window Server上，那么最好使用SQLServer，它是微软的产品，和微软的体系继承起来比较容易。如果是其他编程语言，比如JAVA/PHP/Node等，部署在Linux上，选择MySQL，PgSQL或者Oracle比较好。

另外，也需要考虑成本，通常，开源数据库成本较低。

![](http://ww1.sinaimg.cn/large/af4e9f79ly1g073fa2xsyj21fa0jemyj.jpg)



## 选择数据库引擎

不同的数据库拥有不同的数据库引擎，不同的引擎适用于不同的场景，下面我们看看MySQL的数据库常用数据库引擎：

| 存储引擎    | 是否支持事务 | 锁粒度 | 宜用                   | 忌用                     |
| ----------- | ------------ | ------ | ---------------------- | ------------------------ |
| MyISAM      | 否           | 表级锁 | SELECT                 | 写操作频繁               |
| MRG_MYISAM  | 否           | 表级锁 | 数据仓库               | 全局查找过多             |
| Innodb      | 支持         | 行级锁 | 事务处理               | 无                       |
| Archive     | 否           | 行级锁 | 日志，只支持插入和查询 | 需要随机读取、修改和删除 |
| Ndb cluster | 支持         | 行级锁 | 高可用性               | 大部分应用               |

由此可见，Innodb引擎适用于大部分场景，也是推荐的常用MySQL常用引擎。

参考链接：

* [mysql 数据库引擎](https://www.cnblogs.com/0201zcr/p/5296843.html)
* [ Alternative Storage Engines](https://dev.mysql.com/doc/refman/8.0/en/storage-engines.html)



## 定义库表字段

### 表

####主键

对于一个表来说，尽量自定义主键，如果不定义主键，MySQL会默认自动生成一个不可见的主键。主键可以自动生成主键索引，加快数据的检索速度。所以，选择一个合适的主键至关重要，通常需要注意下面的原则：

* 区分业务主键和数据库主键。

  业务主键用于表示业务数据，通常用于表与表之间的关联；数据库主键通常是为了优化数据存储而设计的，比如默认生成的主键。

* 根据数据库的类型，考虑主键是否要顺序增长。

* 主键的字段类型所占用的空间要尽可能小。

#### 外键

其实，很多时候，我们把外键约束分为物理外键和逻辑外键。

**物理外键：在表与表之间通过数据库外键强关联，完全能够保证数据库数据的完整性。**

**逻辑外键：在外键中使用另一个表的主键，而不强烈定义成外键约束，可以认为在逻辑上是有约束的，不能够完全保证数据的完整性。**

通常推荐定义逻辑外键而不定义物理外键，理由是：

* 降低数据导入的效率。
* 增加维护成本。
* 虽然不建议使用外键约束，但是在相关联的列上一定要建立索引。

推荐阅读：

* [为什么很多mysql课程不推荐用物理外键？](https://www.zhihu.com/question/39062169)
* [数据库外键的使用和原则](https://blog.csdn.net/ycl295644/article/details/49924301)

#### 预留字段

有时候我们会见到有人在设计数据库表的时候，会添加一下目前用不到的列，但是以后可能会用到的列，这种列就叫做预留字段。他们的理由是：**以备日后所需时不更改数据库结构！**

**这里我们强烈不推荐创建预留字段**，理由是：

* 无法准确的知道预留字段的类型。
* 无法准确的知道预留字段中所存储的内容。
* 后期维护预留字段所要的成本同增加一个字段所需要的成本相同。



### 字段

对于字段来说，选择字段类型至关重要，数据类型一方面影响数据存储空间的开销，另一方面也会影响数据的查询性能。通常，**当一个列可以选择多种数据类型时，应该优先考虑数字类型，其次是日期或二进制类型，最后是字符类型。对于相同级别的数据类型，应该优先选择占用空间小的数据类型。**

经常我们会遇到下面几种情况比较难以选择：

#### char & varchar

* 如果列中要存储的数据长度差不多是一致的，应该是考虑用char，否则应该考虑用varchar。
* 如果列中的最大长度小于50byte，一般考虑用char。
* 一般不宜定义大于50byte的char类型列。

#### decimal & float

* decimal用于存储精确的数据，而float只能用于存储非精确数据。
* float的存储空间开销一般比decimal小，应当优先选择。

#### 时间类型

1. 使用int来存储时间字段的优缺点
   * 优点：字段长度比datetime小。
   * 缺点：使用不方便，要进行函数装换。
   * 限制：只能存储到2038-1-19 11:14:07即2^32为2147483648
2. 考虑存储时间的粒度：年 月 日 小时 分钟 秒 周



## 家庭作业

依照前一节逻辑设计的E-R图，运用物理设计的原理，创建相应的表，写出相关的SQL。



