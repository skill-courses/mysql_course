# 分库分表

![database-split](https://tva1.sinaimg.cn/large/008i3skNly1gt78y5sc5fj30mo0ewjrv.jpg)

随着业务的增长，数据库中的数据量也会越来越多，数据库的压力也会越来越大，特别是在数据请求繁忙的阶段，数据库的压力直线下降，这个时候我们可能不得不考虑各种方式来应对数据库出现的压力。前面我们学过高可用架构的设计，知道了主从架构，这种方式可以极大地提升数据库的读负载，但是无法应对大量的写负载。对于写负载，最让人首先想到的解决方案是提升数据库的硬件配置，这种方式虽然可以缓解一时的写负载，但是随着业务的发展，很快就再次出现写负载过大的情况，同时，硬件的升级也有一定的天花板，不可能无限制的升级下去。这节课我们将学习一种终极解决方案：分库分表！

一般情况下，数据库斜切分方案分为两种：垂直拆分(分库)和水平拆分(分表)，这两种方案有各自的优缺点和使用场景，现在我们详细了解一下！

## 垂直拆分(分库)

垂直分库就是将一台机器上面的不同数据库拆分到不同的机器上面去，或者将同一数据库中的表拆分到不同的数据库中去。这种拆分方式和当下的微服务拆分关联紧密，一般情况下，不同的应用程序的服务对应于不同的机器的数据库。

![vertical_shared_db](https://tva1.sinaimg.cn/large/008i3skNly1gt7enrndr0j30e806wwem.jpg)

### 使用场景

这种拆分方式适用于现在流行的微服务架构，能够将不同业务的数据存储到不同机器的数据库中，即做到了不同业务数据的分离，又让冷热数据也进行了分离，可以针对不同数据库的类型选择不同的硬件配置，利于维护并降低数据库整体宕机的概率。

同时，这种方式易于拆分，对于传统的单体服务，仅仅需要通过简单的配置，就可以实现拆分，对老旧系统易于实现。

### 不足之处

如果某些数据库存储的是频繁读写的热数据，那么即使进行了分库，读写负载依旧存在于某个数据库中，读写负载依然没有得到缓解。

## 水平拆分(分表)

针对数据量巨大的单张表（比如订单表），按照某种规则（列规则，RANGE, HASH取模，时间等），切分到多张表里面去。让多张表分配到其他数据库中，实现水平的分库分表。

![horizontal-shard-table](https://tva1.sinaimg.cn/large/008i3skNgy1gt7f425ivvj308l04ja9y.jpg)

这种拆分方式能够从根本上解决写负载，但是其复杂度远远超过想象，特别是对于一些需要跨分表的关联查询以及跨分片的事务来说更是会增加系统的复杂度，所以不到万不得已时不建议进行分库分表。

如果非拆不可，那么请你考虑好以下几种情况：

* 分区键要能尽量避免夸分表的数据查询的发生
* 分区键要尽量保证数据量要在各个表中平均
* 如何存储与拆分表有关联关系的其他表
* 如何将拆分的表分配到不同的数据库中
* 如何生成全局唯一ID

## 拆分工具

如果手动进行拆分和拆分后的维护，这个工作将会相当麻烦，而且还会出现各种意想不到的bug，所以，我们推荐使用一种拆分工具：`oneProxyp`。遗憾的是此工具并不是开源的，所以需要下载编译后的软件来使用，下载地址为：`http://www.onexsoft.cn/software/oneproxy-rhel6-linux64-v5.8.1-ga.tar.gz`。

该工具有多种强大的功能，详情请参考：
* [平民软件OneProxy的强大](https://www.huaweicloud.com/articles/a3564dced0c1ae37d9dafc519bd1a01e.html)
* [OneProxy实现MySQL读写分离](https://www.jianshu.com/p/bdff77400b21)