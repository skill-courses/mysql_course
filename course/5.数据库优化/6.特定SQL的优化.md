# 特定SQL的优化

![sql-tuning](https://tva1.sinaimg.cn/large/008i3skNgy1gt0hvm9wglj308u04fq2t.jpg)

## 大表的数据的修改最好要分批处理

比如对于1000万行的表中修改或者删除100万行记录，最好是一次只删除或者更新1万行的数据。同时，完成一次批量更新之后，最好能够短暂停顿几秒钟，给主从复制的延迟留一点时间。

## 对大表的结构来进行修改

当一个表的数据量足够大，如果我们对表中的列的字段类型进行修改或则对字段的宽度进行修改时，还是会进行锁表，这对实时运行的生产环境还是有影响的。有以下两种方式可以实现：

1. 先在从数据库上面修改，然后进行主从切换，最后在老的服务器上面修改。

这种方式操作复杂，风险较多，而且很多情况下主从数据库的配置不一致，容易降低生产数据库的处理能力。一般情况下不推荐使用。

2. 先在主服务器上面创建一个符合修改要求的新表，然后将数据从老表中同步过来，同时给老表创建一个触发器同步最新的数据，一旦数据同步完成，我们就给老表添加一个排他锁，然后迅速的进行新表的重命名，同时删除老表。

这种方式虽然操作复杂，但是可靠性较高，并且已经有具体的工具来实现了：

```bash
pt-online-schema-change \
--alter="[modify c varchar(150) not null default]" \
--user=root --password=Password \
D=database,t=table \
--charset=utf8 -execute
```

## 使用内连接替换not in和<>查询

一般情况下，mysql会将子查询优化成内连接，但是对于not in等子查询，则不会进行转换，这个时候就需要我们手动进行避免。

