# SQL的预处理及生成计划

![SQL-executing-processes](https://tva1.sinaimg.cn/large/008i3skNgy1gst25v09f0j30xc0hgdjv.jpg)

通过前一节的学习，我们能够定位是那些SQL存在性能问题，但是为什么这些SQL执行起来会变慢呢？SQL的执行到底经历了什么样的过程？这些过程中那些因素会导致SQL执行变慢？要回答这些问题，就需要知道SQL的预处理过程和相应的执行计划，搞清楚这些知识，才能从根本上面优化SQL，这节课程我们就来学习它！

## MySQL对SQL的预处理执行过程

![sql-query-process](https://tva1.sinaimg.cn/large/008i3skNly1gstkjgl3gyj31400u0428.jpg)

上图显示了MySQL对SQL的预处理执行过程，客户端发送SQL请求给服务器，服务器接受到SQL之后先去缓存中进行查询，如果在查询缓存中命中该SQL，直接返回查询结果。

如果不能被查询缓存命中，查询分析器将会对此SQL进行词法分析，将分析出来的关键词组成语法树，交给后续的查询优化器去处理。

查询优化器接受到此语法树之后，会根据执行计划进行最优的选择，匹配合适的索引，选择最佳的执行方案，将生成的最佳执行计划交给后续的查询执行器去处理。

查询执行器根据最佳查询计划，将会依次调用存储引擎层的API，组装存储引擎层的API返回的结果，最后将执行后的结果返回给客户端，完成整个查询过程。

从上面的执行过程可以看出，影响SQL执行性能的过程有以下几种：

### 影响SQL的性能因素

1. 查询缓存的影响：

MySQL中查询缓存的命中率是很低的，它是通过一个对大小写敏感的HASH查找实现的，只要SQL中有任何不一致就无法在缓存中命中，包括简单的大小写都无法规避，同时，如果在存储层中有数据变化，那么查询缓存中的查询也会失效。同时，对缓存查询时，对缓存加锁，对于一个读写频繁的系统使用查询缓存很可能会降低查询处理的效率，所以，一般情况下，会将查询缓存设置为OFF，或者通过客户端来决定是否使用查询缓存。

2. 查询优化器生成的最佳执行计划

查询优化器生成的最佳执行计划对查询有着重要影响，查询优化器是基于统计信息与成本的估算相结合的方式来生成查询计划的，这就意味着，如果统计信息不准确，或者估算的成本与实际的成本不一致，就会造成优化器所认为的最优查询计划并不是实际上最优的查询计划。

3. 存储引擎层的接口性能

不同的存储引擎和不同的磁盘类型，也会影响SQL的性能，比如存储引擎对锁的使用，行级锁和表级锁对读写性能有着较大的影响，一般情况下，我们推荐使用`innoDB`存储引擎，性能和磁盘读写能力都不会太差。

知道了SQL的执行过程，明白了那些阶段会影响SQL的性能之后，我们就需要将其量化，确切的知道每个执行过程的耗时，确定每个过程的优化指标才能对症下药。

## 确定各阶段的耗时

