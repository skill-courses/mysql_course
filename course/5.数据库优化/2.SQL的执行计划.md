# SQL的预处理及生成计划

![SQL-executing-processes](https://tva1.sinaimg.cn/large/008i3skNgy1gst25v09f0j30xc0hgdjv.jpg)

通过前一节的学习，我们能够定位是那些SQL存在性能问题，但是为什么这些SQL执行起来会变慢呢？SQL的执行到底经历了什么样的过程？这些过程中那些因素会导致SQL执行变慢？要回答这些问题，就需要知道SQL的预处理过程和相应的执行计划，搞清楚这些知识，才能从根本上面优化SQL，这节课程我们就来学习它！

## MySQL对SQL的预处理执行过程

![sql-query-process](https://tva1.sinaimg.cn/large/008i3skNly1gstkjgl3gyj31400u0428.jpg)

上图显示了MySQL对SQL的预处理执行过程，客户端发送SQL请求给服务器，服务器接受到SQL之后先去缓存中进行查询，如果在查询缓存中命中该SQL，直接返回查询结果。

如果不能被查询缓存命中，查询分析器将会对此SQL进行词法分析，将分析出来的关键词组成语法树，交给后续的查询优化器去处理。

查询优化器接受到此语法树之后，会根据执行计划进行最优的选择，匹配合适的索引，选择最佳的执行方案，将生成的最佳执行计划交给后续的查询执行器去处理。

查询执行器根据最佳查询计划，将会依次调用存储引擎层的API，组装存储引擎层的API返回的结果，最后将执行后的结果返回给客户端，完成整个查询过程。

从上面的执行过程可以看出，影响SQL执行性能的过程有以下几种：

### 影响SQL的性能因素

1. 查询缓存的影响：

MySQL中查询缓存的命中率是很低的，它是通过一个对大小写敏感的HASH查找实现的，只要SQL中有任何不一致就无法在缓存中命中，包括简单的大小写都无法规避，同时，如果在存储层中有数据变化，那么查询缓存中的查询也会失效。同时，对缓存查询时，对缓存加锁，对于一个读写频繁的系统使用查询缓存很可能会降低查询处理的效率，所以，一般情况下，会将查询缓存设置为OFF，或者通过客户端来决定是否使用查询缓存。

2. 查询优化器生成的最佳执行计划

查询优化器生成的最佳执行计划对查询有着重要影响，查询优化器是基于统计信息与成本的估算相结合的方式来生成查询计划的，这就意味着，如果统计信息不准确，或者估算的成本与实际的成本不一致，就会造成优化器所认为的最优查询计划并不是实际上最优的查询计划。

3. 存储引擎层的接口性能

不同的存储引擎和不同的磁盘类型，也会影响SQL的性能，比如存储引擎对锁的使用，行级锁和表级锁对读写性能有着较大的影响，一般情况下，我们推荐使用`innoDB`存储引擎，性能和磁盘读写能力都不会太差。

知道了SQL的执行过程，明白了那些阶段会影响SQL的性能之后，我们就需要将其量化，确切的知道每个执行过程的耗时，确定每个过程的优化指标才能对症下药。

## 确定各阶段的耗时

### 使用Profile

在MySQL数据库中，可以通过配置profiling参数来启用SQL剖析。该参数可以在全局和session级别来设置。对于全局级别则作用于整个MySQL实例，而session级别仅仅影响当前session。

该参数开启后，后续执行的SQL语句都将记录其资源开销，诸如IO，上下文切换，CPU，Memory等等。根据这些开销进一步分析当前SQL瓶颈从而进行优化与调整。

* 开启profiling, 开启之后可以执行一些sql
```sql
set profiling=1;
```

* 查看当前session所有已产生的profile
```sql
show profiles;
```

* 查看上一条SQL语句的开销信息
```sql
show profile;
```

* 获取指定查询的开销
```sql
show profile for query [Query_ID];
```

* 查看特定部分的开销，如下为CPU/MEMORY部分的开销
```sql
show profile cpu MEMORY for query [Query_ID];
```

上面推荐的这种方法对于SQL调试及其好用，但是对于实时运行的生产环境来说，这种方式低效而且非常不容易捕获数据，在MySQL5.7之后，我们推荐使用下面的方法来统计SQL运行时长：

### performance schema

MySQL的performance schema 用于监控MySQL server在一个较低级别的运行过程中的资源消耗、资源等待等情况。其具有以下几个特点：

1. **提供了一种在数据库运行时实时检查server的内部执行情况的方法。**

performance_schema 数据库中的表使用performance_schema存储引擎。该数据库主要关注数据库运行过程中的性能相关的数据，与information_schema不同，information_schema主要关注server运行过程中的元数据信息

2. **performance_schema通过监视server的事件来实现监视server内部运行情况**

“事件”就是server内部活动中所做的任何事情以及对应的时间消耗，利用这些信息来判断server中的相关资源消耗在了什么地方。一般来说，事件可以是函数调用、操作系统的等待、SQL语句执行的阶段（如sql语句执行过程中的parsing 或 sorting阶段）或者整个SQL语句与SQL语句集合。事件的采集可以方便的提供server中的相关存储引擎对磁盘文件、表I/O、表锁等资源的同步调用信息。performance_schema中的事件记录的是server执行某些活动对某些资源的消耗、耗时、这些活动执行的次数等情况。

3. **收集的事件数据存储在performance_schema数据库的表中。**

这些表可以使用SELECT语句查询，也可以使用SQL语句更新performance_schema数据库中的表记录（如动态修改performance_schema的setup_*开头的几个配置表，但要注意：配置表的更改会立即生效，这会影响数据收集）

4. **performance_schema的表中的数据不会持久化存储在磁盘中，而是保存在内存中，一旦服务器重启，这些数据会丢失（包括配置表在内的整个performance_schema下的所有数据）**

对于此数据库中具体的表存储的事件数据，我们会在后续的章节中介绍。




